<!DOCTYPE html>
<html>
  <!-- Html Head Tag-->
  <head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="你们的威哥">
  <!-- Open Graph Data -->
  <meta property="og:title" content="etcd单台部署，启用https以及ca自签名"/>
  <meta property="og:description" content="" />
  <meta property="og:site_name" content="你们威哥的博客"/>
  <meta property="og:type" content="article" />
  <meta property="og:image" content="https://aronligithub.github.io"/>
  
    <link rel="alternate" href="/atom.xml" title="你们威哥的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  

  <!-- Site Title -->
  <title>你们威哥的博客</title>

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <!-- Custom CSS -->
  
  <link rel="stylesheet" href="/css/style.light.css">

  <!-- Google Analytics -->
  


</head>

  <body >
	
    <!-- Page Header -->


<header class="site-header header-background" style="background-image: url(/img/city_technology.jpg)">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="page-title with-background-image">
          <p class="title">etcd单台部署，启用https以及ca自签名</p>
          <p class="subtitle"></p>
        </div>
        <div class="site-menu with-background-image">
          <ul>
            
              <li>
                <a href="/">
                  
                  Home
                  
                </a>
              </li>
            
              <li>
                <a href="/archives">
                  
                  Archives
                  
                </a>
              </li>
            
              <li>
                <a href="https://github.com/AronLiGitHub">
                  
                  Github
                  
                </a>
              </li>
            
              <li>
                <a href="mailto:357018097@qq.com">
                  
                  Email
                  
                </a>
              </li>
            
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>

<article>
  <div class="container typo">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-info text-muted">
          
            <!-- Author -->
            <span class="author info">By 你们的威哥</span>
          
          <!-- Date -->
          <span class="date-time info">On
            <span class="date">2018-08-13</span>
            <span class="time">00:49:40</span>
          </span>
          
          <!--  Categories  -->
            <span class="categories info">Under 

<a href="/categories/运维开发系列/">运维开发系列</a>
</span>
          
        </div>
        <!-- Tags -->
        
          <div class="post-tags text-muted">
            Tags: 

<a class="tag" href="/tags/kubernetes系列/">#kubernetes系列</a>


          </div>
        
        <!-- Post Main Content -->
        <div class="post-content">
          <blockquote>
<p>#原创内容，转载请注明出处</p>
</blockquote>
<p>博主地址：<a href="https://aronligithub.github.io/">https://aronligithub.github.io/</a></p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><blockquote>
<p><strong><em>在经过上一篇章关于<a href="https://www.jianshu.com/p/e52f9204b7a9" target="_blank" rel="noopener">etcd相关技术概述的铺垫</a>,这个篇章就是介绍以及演示单台etcd部署以及使用CFSSL来生成CA证书</em></strong><br><img src="https://upload-images.jianshu.io/upload_images/13423234-4b7dfae228dbbbfa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br><img src="https://upload-images.jianshu.io/upload_images/13423234-0e2af07b79cf26cd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
</blockquote>
<a id="more"></a>
<h2 id="环境要求"><a href="#环境要求" class="headerlink" title="环境要求"></a>环境要求</h2><blockquote>
<p>1、一台安装centos7的服务器<br>   2、具备访问互联网</p>
</blockquote>
<h2 id="3、关闭服务器的防火墙以及selinux"><a href="#3、关闭服务器的防火墙以及selinux" class="headerlink" title="   3、关闭服务器的防火墙以及selinux"></a>   3、关闭服务器的防火墙以及selinux</h2><h2 id="CFSSL工具的安装"><a href="#CFSSL工具的安装" class="headerlink" title="CFSSL工具的安装"></a>CFSSL工具的安装</h2><blockquote>
<p>下载CFSSL的可执行二进制文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 </span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 </span><br><span class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</span><br><span class="line">chmod +x cfssl*</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h4 id="下载执行过程截图如下"><a href="#下载执行过程截图如下" class="headerlink" title="下载执行过程截图如下"></a>下载执行过程截图如下</h4><blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/13423234-0417209515272faf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="安装wget工具"><br><img src="https://upload-images.jianshu.io/upload_images/13423234-a468ec85ee2a0361.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="下载文件的过程"></p>
</blockquote>
<h2 id=""><a href="#" class="headerlink" title=""></a><img src="https://upload-images.jianshu.io/upload_images/13423234-4f2f93fec52331c1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="给文件添加执行权限"></h2><blockquote>
<p>将这三个二进制可执行文件，修改名称复制到/usr/local/bin/下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cp -v cfssl_linux-amd64 /usr/local/bin/cfssl</span><br><span class="line">cp -v cfssljson_linux-amd64 /usr/local/bin/cfssljson</span><br><span class="line">cp -v cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo</span><br><span class="line">ls /usr/local/bin/cfssl*</span><br></pre></td></tr></table></figure></p>
</blockquote>
<h4 id="下载执行过程截图如下-1"><a href="#下载执行过程截图如下-1" class="headerlink" title="下载执行过程截图如下"></a>下载执行过程截图如下</h4><blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/13423234-a40624bce96e4c26.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="复制可执行文件至指定目录"></p>
</blockquote>
<hr>
<h2 id="使用CFSSL创建CA证书以及etcd的TLS认证证书"><a href="#使用CFSSL创建CA证书以及etcd的TLS认证证书" class="headerlink" title="使用CFSSL创建CA证书以及etcd的TLS认证证书"></a>使用CFSSL创建CA证书以及etcd的TLS认证证书</h2><blockquote>
<p>创建 CA (Certificate Authority)</p>
</blockquote>
<hr>
<blockquote>
<p>   创建 CA 配置文件（ca-config.json）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@server81 cfssl]# vim ca-config.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;etcd&quot;: &#123;</span><br><span class="line">        &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/13423234-3cc0b489b3e70106.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="创建CA配置文件"></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&quot;字段说明&quot;</span><br><span class="line">&quot;ca-config.json&quot;：可以定义多个 profiles，分别指定不同的过期时间、使用场景等参数；后续在签名证书时使用某个 profile；</span><br><span class="line">&quot;signing&quot;：表示该证书可用于签名其它证书；生成的 ca.pem 证书中 CA=TRUE；</span><br><span class="line">&quot;server auth&quot;：表示client可以用该 CA 对server提供的证书进行验证；</span><br><span class="line">&quot;client auth&quot;：表示server可以用该CA对client提供的证书进行验证；</span><br></pre></td></tr></table></figure>
<hr>
<blockquote>
<h4 id="创建-CA-证书签名请求（ca-csr-json）"><a href="#创建-CA-证书签名请求（ca-csr-json）" class="headerlink" title="创建 CA 证书签名请求（ca-csr.json）"></a>创建 CA 证书签名请求（ca-csr.json）</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@server81 cfssl]# vim ca-csr.json</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;etcd&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;shenzhen&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;shenzhen&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;etcd&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/13423234-360e39eb81e9b3c7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="创建CA签名请求"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;CN&quot;：Common Name，etcd 从证书中提取该字段作为请求的用户名 (User Name)；浏览器使用该字段验证网站是否合法；</span><br><span class="line">&quot;O&quot;：Organization，etcd 从证书中提取该字段作为请求用户所属的组 (Group)；</span><br><span class="line">这两个参数在后面的kubernetes启用RBAC模式中很重要，因为需要设置kubelet、admin等角色权限，那么在配置证书的时候就必须配置对了，具体后面在部署kubernetes的时候会进行讲解。</span><br><span class="line">&quot;在etcd这两个参数没太大的重要意义，跟着配置就好。&quot;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<hr>
<blockquote>
<h4 id="生成-CA-证书和私钥"><a href="#生成-CA-证书和私钥" class="headerlink" title="生成 CA 证书和私钥"></a>生成 CA 证书和私钥</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/13423234-d1e08a8f47b6df94.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ca根证书的生成过程"></p>
</blockquote>
<hr>
<h2 id="创建etcd的TLS认证证书"><a href="#创建etcd的TLS认证证书" class="headerlink" title="创建etcd的TLS认证证书"></a>创建etcd的TLS认证证书</h2><blockquote>
<p>创建 etcd证书签名请求（etcd-csr.json）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@server81 cfssl]# vim etcd-csr.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;etcd&quot;,</span><br><span class="line">  &quot;hosts&quot;: [</span><br><span class="line">    &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;172.16.5.81&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;shenzhen&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;shenzhen&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;etcd&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/13423234-ab797365fdb833ab.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="创建etcd证书签名请求"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[^_^]:</span><br><span class="line">       如果 hosts 字段不为空则需要指定授权使用该证书的 IP 或域名列表，由于该证书后续被 etcd 集群使用，所以填写IP即可。</span><br><span class="line">[&gt;_&lt;]:</span><br><span class="line">       因为本次部署etcd是单台，那么则需要填写单台的IP地址即可。</span><br></pre></td></tr></table></figure></p>
</blockquote>
<hr>
<blockquote>
<p>生成 etcd证书和私钥<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@server81 cfssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=etcd etcd-csr.json | cfssljson -bare etcd</span><br><span class="line">[root@server81 cfssl]# ls etcd*</span><br><span class="line">etcd.csr  etcd-csr.json  etcd-key.pem  etcd.pem</span><br><span class="line">[root@server81 cfssl]#</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/13423234-e07f2d7581b666bb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="生成etcd证书以及私钥"></p>
</blockquote>
<hr>
<h2 id="将TLS-认证文件拷贝至证书目录下"><a href="#将TLS-认证文件拷贝至证书目录下" class="headerlink" title="将TLS 认证文件拷贝至证书目录下"></a>将TLS 认证文件拷贝至证书目录下</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/etcd/etcdSSL</span><br><span class="line">cp * /etc/etcd/etcdSSL</span><br><span class="line"></span><br><span class="line">[^_^]:</span><br><span class="line">     存在CA证书的路径&quot;/etc/etcd/etcdSSL&quot;是自定义的，看个人习惯创建即可。</span><br></pre></td></tr></table></figure>
<blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/13423234-92a0162b5eb1258a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
</blockquote>
<hr>
<h2 id="安装etcd服务"><a href="#安装etcd服务" class="headerlink" title="安装etcd服务"></a>安装etcd服务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y etcd</span><br></pre></td></tr></table></figure>
<blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/13423234-6777bf5c0d01c714.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="yum安装etcd"></p>
</blockquote>
<hr>
<blockquote>
<p>配置 etcd 的 service文件（/usr/lib/systemd/system）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@server81 cfssl]# vim /usr/lib/systemd/system/etcd.service </span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">WorkingDirectory=/var/lib/etcd/</span><br><span class="line">EnvironmentFile=-/etc/etcd/etcd.conf</span><br><span class="line"># set GOMAXPROCS to number of processors</span><br><span class="line">ExecStart=/usr/bin/etcd \</span><br><span class="line">  --name $&#123;ETCD_NAME&#125; \</span><br><span class="line">  --cert-file=/etc/etcd/etcdSSL/etcd.pem \</span><br><span class="line">  --key-file=/etc/etcd/etcdSSL/etcd-key.pem \</span><br><span class="line">  --peer-cert-file=/etc/etcd/etcdSSL/etcd.pem \</span><br><span class="line">  --peer-key-file=/etc/etcd/etcdSSL/etcd-key.pem \</span><br><span class="line">  --trusted-ca-file=/etc/etcd/etcdSSL/ca.pem \</span><br><span class="line">  --peer-trusted-ca-file=/etc/etcd/etcdSSL/ca.pem \</span><br><span class="line">  --initial-advertise-peer-urls $&#123;ETCD_INITIAL_ADVERTISE_PEER_URLS&#125; \</span><br><span class="line">  --listen-peer-urls $&#123;ETCD_LISTEN_PEER_URLS&#125; \</span><br><span class="line">  --listen-client-urls $&#123;ETCD_LISTEN_CLIENT_URLS&#125;,http://127.0.0.1:2379 \</span><br><span class="line">  --advertise-client-urls $&#123;ETCD_ADVERTISE_CLIENT_URLS&#125; \</span><br><span class="line">  --initial-cluster-token $&#123;ETCD_INITIAL_CLUSTER_TOKEN&#125; \</span><br><span class="line">  --initial-cluster infra1=https://172.16.5.81:2380 \</span><br><span class="line">  --initial-cluster-state new \</span><br><span class="line">  --data-dir=$&#123;ETCD_DATA_DIR&#125;</span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/13423234-0095d1ace42b3f54.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="配置etcd的service文件"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">参数说明：</span><br><span class="line">1、指定 etcd 的工作目录为 /var/lib/etcd，数据目录为 /var/lib/etcd，需在启动服务前创建这两个目录；</span><br><span class="line">在配置中的命令是这条：</span><br><span class="line">WorkingDirectory=/var/lib/etcd/</span><br><span class="line"></span><br><span class="line">2、为了保证通信安全，需要指定 etcd 的公私钥(cert-file和key-file)、Peers 通信的公私钥和 CA 证书(peer-cert-file、peer-key-file、peer-trusted-ca-file)、客户端的CA证书（trusted-ca-file）；</span><br><span class="line">在配置中添加etcd证书的命令是以下：</span><br><span class="line">  --cert-file=/etc/etcd/etcdSSL/etcd.pem \</span><br><span class="line">  --key-file=/etc/etcd/etcdSSL/etcd-key.pem \</span><br><span class="line">  --peer-cert-file=/etc/etcd/etcdSSL/etcd.pem \</span><br><span class="line">  --peer-key-file=/etc/etcd/etcdSSL/etcd-key.pem \</span><br><span class="line">  --trusted-ca-file=/etc/etcd/etcdSSL/ca.pem \</span><br><span class="line">  --peer-trusted-ca-file=/etc/etcd/etcdSSL/ca.pem \</span><br><span class="line"></span><br><span class="line">3、配置etcd的endpoint：</span><br><span class="line">  --initial-cluster infra1=https://172.16.5.81:2380 \</span><br><span class="line"></span><br><span class="line">4、配置etcd的监听服务集群：</span><br><span class="line">  --initial-advertise-peer-urls $&#123;ETCD_INITIAL_ADVERTISE_PEER_URLS&#125; \</span><br><span class="line">  --listen-peer-urls $&#123;ETCD_LISTEN_PEER_URLS&#125; \</span><br><span class="line">  --listen-client-urls $&#123;ETCD_LISTEN_CLIENT_URLS&#125;,http://127.0.0.1:2379 \</span><br><span class="line">  --advertise-client-urls $&#123;ETCD_ADVERTISE_CLIENT_URLS&#125; \</span><br><span class="line"></span><br><span class="line">5、配置etcd创建的集群为新集群，则定义集群状态为new</span><br><span class="line">   --initial-cluster-state 值为 new</span><br><span class="line"></span><br><span class="line">6、定义etcd节点的名称，该名称等下从配置文件中获取：</span><br><span class="line">  --name $&#123;ETCD_NAME&#125; \ </span><br><span class="line">  其中配置文件：EnvironmentFile=-/etc/etcd/etcd.conf</span><br></pre></td></tr></table></figure></p>
</blockquote>
<hr>
<blockquote>
<p>etcd的配置文件（/etc/etcd/etcd.conf）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@server81 cfssl]# vim /etc/etcd/etcd.conf</span><br><span class="line"></span><br><span class="line">#[member]</span><br><span class="line">ETCD_NAME=infra1</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://172.16.5.81:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://172.16.5.81:2379&quot;</span><br><span class="line"></span><br><span class="line">#[cluster]</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://172.16.5.81:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://172.16.5.81:2379&quot;</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/13423234-8f2659d2a2e22804.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="etcd节点的参数配置文件"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这是172.16.5.81节点的配置，如果配置其他etcd节点只要将上面的IP地址改成相应节点的IP地址即可。</span><br></pre></td></tr></table></figure></p>
</blockquote>
<hr>
<blockquote>
<p>启动 etcd 服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start etcd</span><br><span class="line">systemctl status etcd</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/13423234-1cb20dfab0366681.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="启动etcd服务"></p>
</blockquote>
<hr>
<blockquote>
<p>验证服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">etcdctl \</span><br><span class="line">  --ca-file=/etc/etcd/etcdSSL/ca.pem \</span><br><span class="line">  --cert-file=/etc/etcd/etcdSSL/etcd.pem \</span><br><span class="line">  --key-file=/etc/etcd/etcdSSL/etcd-key.pem \</span><br><span class="line">  cluster-health</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p><img src="https://upload-images.jianshu.io/upload_images/13423234-f307491c8fd51946.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="检查etcd集群健康状态"></p>
</blockquote>
<hr>
<h2 id="最后的总结"><a href="#最后的总结" class="headerlink" title="最后的总结"></a>最后的总结</h2><blockquote>
<p><strong><em>从上面的流程对于新手基本都是可以复制黏贴就可以完成的了，那么对于需要提升的朋友，在以后的篇章我会逐个加入自动化部署的写法说明，已写完的自动化部署如下图所示：</em></strong><br><img src="https://upload-images.jianshu.io/upload_images/13423234-9d38f7cd2472631e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="自动化部署脚本展示"></p>
</blockquote>
<hr>
<h2 id="下一个篇章则是写三台etcd的部署集群了，过程基本差不多，不过也写给朋友们看看吧。"><a href="#下一个篇章则是写三台etcd的部署集群了，过程基本差不多，不过也写给朋友们看看吧。" class="headerlink" title="下一个篇章则是写三台etcd的部署集群了，过程基本差不多，不过也写给朋友们看看吧。"></a>下一个篇章则是写三台etcd的部署集群了，过程基本差不多，不过也写给朋友们看看吧。</h2><blockquote>
<p>如果你想要看我写的总体系列文章目录介绍，可以点击<a href="https://www.jianshu.com/p/4a9c06ea570b" target="_blank" rel="noopener">kuberntes以及运维开发文章目录介绍</a></p>
</blockquote>

        </div>
      </div>
    </div>
  </div>
</article>



    <!-- Footer -->
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<footer>

  <!--pv的方式，单个用户连续点击n篇文章，记录n次访问量-->
  <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>

  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <p class="copyright text-muted">
          Theme By <a target="_blank" href="https://github.com/levblanc">Levblanc.</a>
          Inspired By <a target="_blank" href="https://github.com/klugjo/hexo-theme-clean-blog">Clean Blog.</a>
        <p class="copyright text-muted">
          Powered By <a target="_blank" href="https://hexo.io/">Hexo.</a>
        </p>
      </div>
    </div>
  </div>

</footer>


    <!-- After Footer Scripts -->
<script src="/js/highlight.pack.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function(event) {
    var codeBlocks = Array.prototype.slice.call(document.getElementsByTagName('pre'))
    codeBlocks.forEach(function(block, index) {
      hljs.highlightBlock(block);
    });
  });
</script>

   	
  </body>
</html>

